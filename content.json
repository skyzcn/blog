{"meta":{"title":"老代码","subtitle":"代码片段","description":"PL/SQL, Java, Javascript 代码片段, 代码备忘","author":"程宣峰","url":"http://oracle.xyz"},"pages":[{"title":"个人介绍","date":"2017-04-21T11:37:31.000Z","updated":"2017-04-28T12:03:31.424Z","comments":true,"path":"about/index.html","permalink":"http://oracle.xyz/about/index.html","excerpt":"","text":"联系方式 手机: 18607935958 (微信) Email: skyz.cn#gmail.com 个人信息 个人标签: 程宣峰 男 32岁 已婚 工作年限: 10年 个人主页: www.skyz.cn 个人介绍: 10多年的Oracle HRMS以及周边系统建设经验."}],"posts":[{"title":"PLSQL并行处理的例子-parallel","slug":"plsql-parallel-util-file","date":"2017-04-28T11:58:27.000Z","updated":"2017-04-28T12:51:19.254Z","comments":true,"path":"posts/plsql-parallel-util-file.html","link":"","permalink":"http://oracle.xyz/posts/plsql-parallel-util-file.html","excerpt":"","text":"创建一个临时表并insert 一百万条记录, 然后读取这一百万条记录写入文件. 准备创建测试的表123456789101112CREATE TABLE source_data ( x, y, z , CONSTRAINT source_data_pk PRIMARY KEY (x,y,z) ) ORGANIZATION INDEX AS SELECT ROWNUM AS x , RPAD(&apos;x&apos;,50,&apos;x&apos;) AS y , RPAD(&apos;y&apos;,50,&apos;y&apos;) AS z FROM dual CONNECT BY ROWNUM &lt;= 1000000; 存放测试文件的目录1CREATE DIRECTORY dump_dir AS &apos;/u01/app/oracle/dir&apos;; 代码启用并行的管道函数12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455 CREATE FUNCTION parallel_dump ( p_source IN SYS_REFCURSOR, p_filename IN VARCHAR2, p_directory IN VARCHAR2 ) RETURN dump_ntt PIPELINED PARALLEL_ENABLE (PARTITION p_source BY ANY) AS TYPE row_ntt IS TABLE OF VARCHAR2(32767); v_rows row_ntt; v_file UTL_FILE.FILE_TYPE; v_buffer VARCHAR2(32767); v_sid NUMBER; v_name VARCHAR2(128); v_lines PLS_INTEGER := 0; c_eol CONSTANT VARCHAR2(1) := CHR(10); c_eollen CONSTANT PLS_INTEGER := LENGTH(c_eol); c_maxline CONSTANT PLS_INTEGER := 32767;BEGIN SELECT sid INTO v_sid FROM v$mystat WHERE ROWNUM = 1; v_name := p_filename || &apos;_&apos; || TO_CHAR(v_sid) || &apos;.txt&apos;; v_file := UTL_FILE.FOPEN(p_directory, v_name, &apos;w&apos;, 32767); LOOP FETCH p_source BULK COLLECT INTO v_rows LIMIT 100; FOR i IN 1 .. v_rows.COUNT LOOP IF LENGTH(v_buffer) + c_eollen + LENGTH(v_rows(i)) &lt;= c_maxline THEN v_buffer := v_buffer || c_eol || v_rows(i); ELSE IF v_buffer IS NOT NULL THEN UTL_FILE.PUT_LINE(v_file, v_buffer); END IF; v_buffer := v_rows(i); END IF; END LOOP; v_lines := v_lines + v_rows.COUNT; EXIT WHEN p_source%NOTFOUND; END LOOP; CLOSE p_source; UTL_FILE.PUT_LINE(v_file, v_buffer); UTL_FILE.FCLOSE(v_file); PIPE ROW (dump_ot(v_name, v_lines, v_sid)); RETURN;END parallel_dump;/ 拆成4个子任务来生成文件 1234567891011SELECT * FROM TABLE( parallel_dump( CURSOR(SELECT /*+ PARALLEL(s,4) */ x ||&apos;,&apos;|| y ||&apos;,&apos;|| z AS csv FROM source_data s), &apos;utl_file_parallel_pipelined&apos;, &apos;DUMP_DIR&apos; )) nt; 生成的测试文件: FILE_NAME NO_RECORDS SESSION_ID utl_file_parallel_pipelined_136.txt 190758 136 utl_file_parallel_pipelined_135.txt 192640 135 utl_file_parallel_pipelined_117.txt 288960 117 utl_file_parallel_pipelined_121.txt 327642 121 参考tuning pl/sql file i/o","categories":[{"name":"DB","slug":"DB","permalink":"http://oracle.xyz/categories/DB/"}],"tags":[]},{"title":"工作相关的代码整理","slug":"common-sql-package","date":"2017-04-21T13:53:51.000Z","updated":"2017-04-26T12:11:52.058Z","comments":true,"path":"posts/common-sql-package.html","link":"","permalink":"http://oracle.xyz/posts/common-sql-package.html","excerpt":"","text":"工具发送邮件 cux_fnd_sendmail_pkg多个附件1234567891011121314151617181920212223242526DECLARE l_attachment_table cux_fnd_sendmail_pkg.t_attach_blob_table; ...BEGIN ... --添加到附件表 l_attachment_table(1).t_name := l_attach_file_name; l_attachment_table(1).t_ddl := g_zipped_blob; l_attachment_table(1).t_ext := &apos;zip&apos;; l_attachment_table(1).t_content_type := &apos;multipart/alternative&apos;; ... l_attachment_table(2).t_name := l_attach_file_name; l_attachment_table(2).t_ddl := cux_fnd_xls_pkg.finish; l_attachment_table(2).t_ext := &apos;xlsx&apos;; l_attachment_table(2).t_content_type := &apos;multipart/alternative&apos;; ... cux_fnd_sendmail_pkg.send_mail_attach_blob_t_c(p_from_email =&gt; &apos;erp@oracle.com&apos;, p_receiver_address =&gt; l_receiver_address, p_receive_name =&gt; l_receiver_address, p_email_subject =&gt; l_email_subject, p_email_body =&gt; l_email_body, p_cc_name =&gt; l_cc_address, p_attachment_table =&gt; l_attachment_table); END; 图文1234567cux_fnd_sendmail_pkg.send_mail_with_image(p_from_email =&gt; v_sender_email, p_receiver_address =&gt; c_per.email_address, p_receive_name =&gt; c_per.last_name, p_email_subject =&gt; v_mail_title, p_email_body =&gt; v_mail_body, p_cc_name =&gt; v_cc_email, p_attachment_table =&gt; v_attach_blob_table); markdown cux_fnd_markdown_pkg1cux_pay_tax_plan_pkg.report 汉字转拼音 cux_fnd_pinyin_pkg1SELECT cux_fnd_pinyin_pkg.gethzfullpy(&apos;程宣峰&apos;) FROM dual 读取excel的内容 cux_fnd_read_xlsx_pkg12/* 不建临时表使用excel上传文件. */cux_per_upload_email_pkg 创建excel cux_fnd_xls_pkg12// 创建excel报表 cux_hcm_abs_deduct_pkg.report 压缩文件12345678910DECLARE g_zipped_blob BLOB;BEGIN FOR rec IN csr LOOP cux_fnd_xls_pkg.add1file(g_zipped_blob, rec.file_name, rec.attachment_content); cux_fnd_xls_pkg.finish_zip(g_zipped_blob, &apos;&apos;); END LOOP;END; BPM 流程1234567891011121314// 启动流程cux_bpm_utility_pkg.create_process// 启动空流程cux_bpm_utility_pkg.create_notify// 撤回cux_bpm_utility_pkg.abort_process// 审批通过cux_bpm_utility_pkg.approve_process// 拒绝cux_bpm_utility_pkg.reject_process// 当前审批人cux_bpm_common_pkg.get_uuap_username// 当前审批节点cux_bpm_utility_pkg.get_current_task_val MQ 数据同步12345hcm_common_pkg.call_plsql_main_json(p_plsql_api =&gt; &apos;cux_hcm_bo_pkg.get_pay_lines&apos;, p_msg_json =&gt; l_msg, p_http_apex =&gt; &apos;APEX&apos;, o_errcode =&gt; o_errcode, o_errmsg =&gt; o_errmsg); 百度hi通知接口 待整理 调用波塞冬的服务12345678910bp_databus_api_pkg.start_di_flow(p_di_request_id =&gt; -1, p_di_channel_code =&gt; &apos;PN_DC_UNFIN_PERMISSION&apos;, p_di_transformation_code =&gt; &apos;APPLAT_UNFIN_PERMISSION&apos;, p_di_job_codes =&gt; &apos;UNFIN_PERMISSION_USERINFO,UNFIN_PERMISSION_DUTY,UNFIN_PERMISSION_USERDUTY&apos;, p_di_business_batch_num =&gt; &apos;p_di_business_batch_num&apos;, p_di_operator =&gt; &apos;p_di_operator&apos;, p_di_batch_num =&gt; &apos;1,1,1&apos;, p_di_batch_sizes =&gt; l_di_batch_size, o_ret_code =&gt; l_error_code, o_ret_msg =&gt; l_error_msg); FYI小熊通知主库小熊通知表: cux_ext_notifications_pub.create_fyi_msg分库小熊通知表: cux_ext_polar_fyi_pub.create_fyi_msg MD5加密1SELECT utl_raw.cast_to_raw(dbms_obfuscation_toolkit.md5(input_string =&gt; &apos;chengxuanfeng&apos;)) FROM dual; 对url进行编码和解码12345BEGIN dbms_output.put_line(utl_url.escape(&apos;http://www.baidu.com/参数/=+/&apos;,TRUE,&apos;UTF8&apos;)); dbms_output.put_line(utl_url.escape(&apos;http://www.baidu.com/参数/=+/&apos;,false,&apos;UTF8&apos;)); dbms_output.put_line( utl_url.unescape(&apos;http%3A%2F%2Fwww.baidu.com%2F%E5%8F%82%E6%95%B0%2F%3D%2B%2F&apos;,&apos;UTF8&apos;));END; 调用web请求1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859FUNCTION get_audio(p_text IN VARCHAR2) RETURN BLOB IS l_req_blob BLOB; l_res_blob BLOB; l_url VARCHAR2(32767) := get_tts_url(); l_cuid VARCHAR2(32767); l_req utl_http.req; l_res utl_http.resp;BEGIN SELECT instance || &apos;-&apos; || &apos;-&apos; || userenv(&apos;sessionid&apos;) INTO l_cuid FROM v$thread; l_url := REPLACE(l_url, &apos;#text#&apos;, p_text || chr(38)); l_url := REPLACE(l_url, &apos;#token#&apos;, get_access_token); l_url := REPLACE(l_url, &apos;#cuid#&apos;, l_cuid); log(l_url); l_req := utl_http.begin_request(l_url, &apos;GET&apos;); dbms_lob.createtemporary(lob_loc =&gt; l_req_blob, cache =&gt; FALSE); utl_http.write_raw(l_req, l_req_blob); l_res := utl_http.get_response(l_req); dbms_output.put_line(&apos;Response&gt; status_code: &quot;&apos; || l_res.status_code || &apos;&quot;&apos;); dbms_output.put_line(&apos;Response&gt; reason_phrase: &quot;&apos; || l_res.reason_phrase || &apos;&quot;&apos;); dbms_output.put_line(&apos;Response&gt; http_version: &quot;&apos; || l_res.http_version || &apos;&quot;&apos;); DECLARE l_raw_data RAW(512); --chunk_size CONSTANT INTEGER := 512; BEGIN dbms_lob.createtemporary(l_res_blob, FALSE); LOOP BEGIN utl_http.read_raw(l_res, l_raw_data); IF l_raw_data IS NOT NULL THEN dbms_lob.writeappend(l_res_blob, utl_raw.length(l_raw_data), l_raw_data); END IF; EXCEPTION WHEN utl_http.end_of_body THEN utl_http.end_response(l_res); EXIT; END; END LOOP; END; IF l_req.private_hndl IS NOT NULL THEN utl_http.end_request(l_req); END IF; IF l_res.private_hndl IS NOT NULL THEN utl_http.end_response(l_res); END IF; --dbms_lob.freetemporary(l_res_blob); RETURN l_res_blob;END; 12345678910111213141516171819--发送hi, 默认文本. PROCEDURE hi(p_message_type IN VARCHAR2 := &apos;text&apos;, p_hi_number IN VARCHAR2, p_content IN VARCHAR2) IS l_response_text VARCHAR2(2000); l_url VARCHAR2(32767) := get_hi_service(); l_payload CLOB := get_hi_payload(); BEGIN l_payload := REPLACE(l_payload, &apos;#MESSAGE_TYPE#&apos;, p_message_type); l_payload := REPLACE(l_payload, &apos;#HI_NUMBER#&apos;, p_hi_number); l_payload := REPLACE(l_payload, &apos;#CONTENT#&apos;, p_content); -- apex_web_service.g_request_headers(1).name := &apos;Content-Type&apos;; apex_web_service.g_request_headers(1).value := &apos;application/x-www-form-urlencoded&apos;; l_response_text := apex_web_service.make_rest_request(p_url =&gt; l_url, p_http_method =&gt; &apos;POST&apos;, p_body =&gt; l_payload); log(l_response_text); END;","categories":[{"name":"DB","slug":"DB","permalink":"http://oracle.xyz/categories/DB/"}],"tags":[]},{"title":"日常运维的查询 - FND","slug":"common-sql-query","date":"2017-04-21T09:41:51.000Z","updated":"2017-04-26T08:53:08.393Z","comments":true,"path":"posts/common-sql-query.html","link":"","permalink":"http://oracle.xyz/posts/common-sql-query.html","excerpt":"","text":"Alert - 查询预警邮件的日志12345SELECT extractvalue(xmltype(O.&quot;SYS_NC00040$&quot;), &apos;//SUBJECT&apos;) subject ,to_char(enq_time, &apos;YYYY/MM/DD HH24:MI:SS&apos;) end_time ,row_number() over(ORDER BY enq_time DESC) rn FROM apps.wf_notification_out o WHERE o.corrid LIKE &apos;APPS:ALR%&apos;; Concurent请求名称对应的可执行文件12345678SELECT e.execution_file_name FROM fnd_concurrent_programs p ,fnd_executables e WHERE p.executable_id = e.executable_id AND p.concurrent_program_id IN (SELECT t.concurrent_program_id FROM fnd_concurrent_programs_tl t WHERE t.user_concurrent_program_name = &apos;请求名称&apos;); 请求运行时正在执行的SQL12345SELECT s.* FROM fnd_concurrent_requests r, v$session v, v$sql s WHERE r.oracle_session_id = v.audsid AND v.sql_id = s.sql_id AND r.request_id = 543339; Apex restful12345678910// 查询select * from apex_rest_resource_modules WHERE workspace LIKE &apos;%MQ%&apos;; // apex urlselect * from apex_rest_resource_handlers WHERE workspace LIKE &apos;%MQ%&apos;; select * from apex_rest_resource_parameters WHERE workspace LIKE &apos;%MQ%&apos;; select * from apex_rest_resource_templates WHERE workspace LIKE &apos;%MQ%&apos;;// 清空apex的workspaceBEGIN apex_instance_admin.remove_workspace(&apos;MQBONUS&apos;); END;","categories":[{"name":"DB","slug":"DB","permalink":"http://oracle.xyz/categories/DB/"}],"tags":[]}]}